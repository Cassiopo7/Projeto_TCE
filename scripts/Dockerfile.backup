# Dockerfile para servi√ßo de backup autom√°tico
FROM alpine:latest

# Instalar PostgreSQL client e depend√™ncias
RUN apk add --no-cache \
    postgresql-client \
    bash \
    curl \
    && rm -rf /var/cache/apk/*

# Criar diret√≥rio de trabalho
WORKDIR /app

# Copiar scripts de backup
COPY backup_database.sh .
COPY restore_database.sh .

# Tornar scripts execut√°veis
RUN chmod +x *.sh

# Criar diret√≥rio para backups
RUN mkdir -p /app/backups

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD pg_isready -h ${DB_HOST:-postgres} -p ${DB_PORT:-5432} -U ${DB_USER:-postgres} || exit 1

# Comando padr√£o: executar backup e depois dormir
CMD ["bash", "-c", "
    echo 'üíæ Servi√ßo de backup iniciado...'
    while true; do
        echo \"üìÖ Executando backup - $(date)\"
        ./backup_database.sh production
        echo \"‚úÖ Backup conclu√≠do. Pr√≥ximo em ${BACKUP_INTERVAL_MINUTES:-60} minutos...\"
        sleep $(( ${BACKUP_INTERVAL_MINUTES:-60} * 60 ))
    done
"]
