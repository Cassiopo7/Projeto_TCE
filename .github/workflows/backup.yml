name: ğŸ’¾ Database Backup

on:
  schedule:
    # Executa todos os dias Ã s 2:00 AM UTC (22:00 PM BRT)
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente para backup'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

env:
  BACKUP_ENVIRONMENT: ${{ github.event.inputs.environment || 'production' }}

jobs:
  backup:
    runs-on: ubuntu-latest
    environment: ${{ env.BACKUP_ENVIRONMENT }}

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Install PostgreSQL client
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client

    - name: ğŸ—„ï¸ Execute Database Backup
      run: |
        echo "ğŸ’¾ Executando backup automÃ¡tico..."
        echo "ğŸŒ Ambiente: ${{ env.BACKUP_ENVIRONMENT }}"
        echo "ğŸ“… Data/Hora: $(date)"

        # Configurar variÃ¡veis de ambiente
        export DB_HOST=${{ secrets.DB_HOST_PROD }}
        export DB_PORT=${{ secrets.DB_PORT_PROD }}
        export DB_NAME=${{ secrets.DB_NAME_PROD }}
        export DB_USER=${{ secrets.DB_USER_PROD }}
        export DB_PASSWORD=${{ secrets.DB_PASSWORD_PROD }}

        # Executar backup
        chmod +x scripts/backup_database.sh
        ./scripts/backup_database.sh ${{ env.BACKUP_ENVIRONMENT }}

    - name: ğŸ“¤ Upload Backup to Storage
      uses: actions/upload-artifact@v4
      with:
        name: database-backup-${{ env.BACKUP_ENVIRONMENT }}-${{ github.run_number }}
        path: backups/
        retention-days: 30

    - name: ğŸ“§ Send Notification
      if: always()
      run: |
        echo "ğŸ“§ Enviando notificaÃ§Ã£o de backup..."
        echo "ğŸ“Š Status: ${{ job.status }}"
        echo "ğŸŒ Ambiente: ${{ env.BACKUP_ENVIRONMENT }}"
        echo "ğŸ“… Timestamp: $(date)"

        # Aqui vocÃª pode integrar com serviÃ§os de notificaÃ§Ã£o
        # como Slack, Discord, email, etc.

  cleanup:
    runs-on: ubuntu-latest
    needs: backup
    if: success()

    steps:
    - name: ğŸ§¹ Cleanup Old Backups
      run: |
        echo "ğŸ§¹ Limpando backups antigos..."

        # Listar artifacts (simulaÃ§Ã£o)
        echo "ğŸ“¦ Backups atuais:"
        echo "  - backup_20241201_020000_production.sql"
        echo "  - backup_20241202_020000_production.sql"
        echo "  - backup_20241203_020000_production.sql"

        echo "âœ… Cleanup completed (implement based on your storage)"
